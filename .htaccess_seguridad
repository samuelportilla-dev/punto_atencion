# Protección Avanzada para El Punto de Atención
# Bloquea bots maliciosos y ataques automáticos

RewriteEngine On

# ========================================
# BLOQUEO DE BOTS MALICIOSOS
# ========================================

# Bloquear IPs maliciosas conocidas
<Files "*.php">
    Order Allow,Deny
    Deny from 20.41.85.46
    Deny from 185.220.101
    Deny from 185.220.102
    Deny from 185.220.103
    Deny from 185.220.104
    Allow from all
</Files>

# Bloquear User-Agents maliciosos
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} ^(java|curl|wget) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^.*(libwww-perl|curl|wget|python|nikto|wkito|pikto|acunetix|scan|acunetix).*$ [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^.*(winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner).*$ [NC]
RewriteRule .* - [F,L]

# Bloquear archivos PHP maliciosos comunes
RewriteRule ^(geck|fm|shout|size|wp-gr|wp-mn|wp-mt|ww|111|ova|abcd|chosen|123|we|goat|ioxi-o|v|ar|qing|lv|mms|gmo|dev|lite|error|pp|a1|a2|bless|lock360|alfa|ee|6|12|02|2|13|13k|css|bypass|3|10|kk|cf|456|7|dropdown|2x|aa|goods|pepe|file32|file|x|11|class20|ll|atomlib|system_log|asus|wp|xx|jp|html)\.php$ - [F,L]

# ========================================
# PROTECCIÓN DE ARCHIVOS SENSIBLES
# ========================================

# Bloquear acceso directo a archivos de configuración
<FilesMatch "^(config|includes)/.*\.(php|sql|log)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Bloquear acceso a archivos de sistema
<FilesMatch "^(\.htaccess|\.htpasswd|\.env|config\.php|database\.php)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Permitir solo archivos específicos
<Files "*.php">
    <FilesMatch "^(index|test_error|install|setup_hosting|execute_sql_safe)\.php$">
        Order Allow,Deny
        Allow from all
    </FilesMatch>
    
    <FilesMatch "^pages/.*\.php$">
        Order Allow,Deny
        Allow from all
    </FilesMatch>
</Files>

# ========================================
# LIMITACIÓN DE RATE LIMITING
# ========================================

# Limitar requests por IP
<IfModule mod_evasive20.c>
    DOSHashTableSize 3097
    DOSPageCount 2
    DOSSiteCount 50
    DOSPageInterval 1
    DOSSiteInterval 1
    DOSBlockingPeriod 10
</IfModule>

# ========================================
# HEADERS DE SEGURIDAD
# ========================================

# Headers de seguridad
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# ========================================
# COMPRESIÓN Y CACHÉ
# ========================================

# Compresión GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Caché de archivos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# ========================================
# CONFIGURACIÓN DE ERRORES
# ========================================

# Páginas de error personalizadas
ErrorDocument 404 /punto_atencion/404.html
ErrorDocument 500 /punto_atencion/500.html
ErrorDocument 403 /punto_atencion/403.html

# ========================================
# CONFIGURACIÓN PHP
# ========================================

# Configuración PHP específica
<IfModule mod_php.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 300
    php_value max_input_vars 3000
    php_flag display_errors Off
    php_flag log_errors On
</IfModule>
